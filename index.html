<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Expiry Auditor</title>

<style>
body{
  font-family: Arial;
  padding:15px;
  background:#121212;
  color:#fff;
}
.card{
  background:#1f1f1f;
  padding:15px;
  margin-bottom:12px;
  border-radius:10px;
  box-shadow:0 0 6px #000;
}
input,button,select{
  padding:10px;
  width:100%;
  margin:6px 0;
  border-radius:6px;
  border:1px solid #777;
  background:#2b2b2b;
  color:white;
}
button{
  background:#007bff;
  border:none;
  font-weight:bold;
}
button:hover{opacity:.8;}
.status{
  padding:8px;
  margin-top:6px;
  font-weight:bold;
  text-align:center;
  border-radius:6px;
}
.ok{background:#155724;color:#9dff9d;}
.warn{background:#856404;color:#fff7ac;}
.exp{background:#721c24;color:#ffb3b3;}
.hidden{display:none;}

.table-wrap{overflow-x:auto;}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:12px;
  min-width:1000px;
}
td,th{
  border:1px solid #666;
  padding:6px;
  text-align:center;
}
.actionBtn{
  background:#ff4444;
  padding:4px 8px;
  border-radius:4px;
  margin:2px;
}
.editBtn{
  background:#ffaa00;
  padding:4px 8px;
  border-radius:4px;
  margin:2px;
}
</style>
</head>

<body>
<h2><b>Expiry Auditor (FSSAI)</b></h2>

<div class="card">
<label>MFG Date</label><input type="date" id="mfgDate">
<label>EXP Date</label><input type="date" id="expDate">
<label>Current Date</label><input type="date" id="currentDate">
</div>

<div class="card hidden" id="results">
<p><b>Total Shelf Life:</b> <span id="totalLife"></span> days</p>
<p><b>Remaining Life:</b> <span id="remainDays"></span></p>
<p><b>10% Near Expiry Date:</b> <span id="nearDate"></span></p>
<p id="statusP" class="status"></p>
</div>

<!-- SAVE PRODUCT -->
<div id="saveCard" class="card hidden">
<h3>Save Product</h3>

<input placeholder="Product Name" id="pName">

<!-- ðŸ”¥ ARTICLE NUMBER ADDED -->
<input placeholder="Article Number" id="pArtiNo">

<input placeholder="Batch No" id="pBatch">
<input placeholder="Barcode" id="pBarcode">
<input placeholder="Manufacturer" id="pMfg">
<input placeholder="Price" id="pPrice" type="number">
<input placeholder="Quantity" id="pQty" type="number">

<select id="pReason">
  <option value="">Select Reason</option>
  <option value="Lack of FIFO">Lack of FIFO</option>
  <option value="Non-moving item">Non-moving item</option>
</select>

<button onclick="saveProduct()">SAVE ENTRY</button>
</div>

<div class="card">
<h3>Saved Near-Expiry Items</h3>

<div class="table-wrap">
<table id="reportTable">

<thead><tr>
<th>Name</th>

<!-- ðŸ”¥ ARTICLE NUMBER ADDED -->
<th>Article Number</th>

<th>Batch No</th>
<th>Barcode</th>
<th>Manufacturer</th>
<th>MFG</th>
<th>EXP</th>
<th>Audit Date</th>
<th>% Left</th>
<th>Qty</th>
<th>Price</th>
<th>Reason</th>
<th>Action</th>
</tr></thead>

<tbody id="reportBody"></tbody>
</table>
</div>

<button onclick="exportCSV()">EXPORT CSV</button>
<button onclick="resetReport()">CLEAR ALL</button>
</div>

<script>
const daysBetween=(a,b)=>Math.ceil((new Date(b)-new Date(a))/(1000*60*60*24));
const addDays=(d,x)=>{let dt=new Date(d);dt.setDate(dt.getDate()+Math.floor(x));return dt.toISOString().split('T')[0];};

const mfgDate=document.getElementById("mfgDate");
const expDate=document.getElementById("expDate");
const currentDate=document.getElementById("currentDate");
const results=document.getElementById("results");
const saveCard=document.getElementById("saveCard");
const totalLife=document.getElementById("totalLife");
const remainDays=document.getElementById("remainDays");
const nearDate=document.getElementById("nearDate");
const statusP=document.getElementById("statusP");
const body=document.getElementById("reportBody");

function calculate(){
  const m=mfgDate.value, e=expDate.value, c=currentDate.value;
  if(!m||!e){return;}

  const total   = daysBetween(m,e);
  const remaining = daysBetween(c,e);
  const percentLeft = ((remaining/total)*100).toFixed(1);
  const near = addDays(e,-(total*0.10));

  totalLife.textContent=total;
  remainDays.textContent=`${remaining} days (${percentLeft}% left)`;
  nearDate.textContent=near;
  results.classList.remove("hidden");

  if(remaining<0){ status("EXPIRED","exp"); }
  else if(remaining <= Math.ceil(total*0.10)){ status("NEAR EXPIRY","warn"); }
  else{ status("OK","ok"); }

  if(statusP.classList.contains("warn")||statusP.classList.contains("exp"))
      saveCard.classList.remove("hidden");
  else saveCard.classList.add("hidden");

  return {m,e,c,total,remaining,percentLeft};
}

function status(txt,cls){
  statusP.textContent=txt;
  statusP.className="status "+cls;
}

function saveProduct(){
  const data = calculate();
  const entry = {
    name: pName.value,

    /* ðŸ”¥ ARTICLE NUMBER ADDED */
    artiNo: pArtiNo.value,

    batch: pBatch.value,
    barcode: pBarcode.value,
    mfgName: pMfg.value,
    mfg: data.m,
    exp: data.e,
    audit: data.c,
    pct: data.percentLeft,
    qty: pQty.value,
    price: pPrice.value,
    reason: pReason.value
  };

  let arr = JSON.parse(localStorage.getItem("expiryAudit")||"[]");
  arr.push(entry);
  localStorage.setItem("expiryAudit",JSON.stringify(arr));

  clearForm();
  loadTable();
  alert("Saved!");
}

function clearForm(){
  document.querySelectorAll("#saveCard input, #saveCard select").forEach(i=>i.value="");
}

function loadTable(){
  let arr = JSON.parse(localStorage.getItem("expiryAudit")||"[]");
  body.innerHTML="";
  arr.forEach((r,i)=>{
    body.innerHTML+=`<tr>
      <td>${r.name}</td>

      <!-- ðŸ”¥ ARTICLE NUMBER ADDED -->
      <td>${r.artiNo}</td>

      <td>${r.batch}</td>
      <td>${r.barcode}</td>
      <td>${r.mfgName}</td>
      <td>${r.mfg}</td>
      <td>${r.exp}</td>
      <td>${r.audit}</td>
      <td>${r.pct}%</td>
      <td>${r.qty}</td>
      <td>${r.price}</td>
      <td>${r.reason}</td>
      <td>
        <button class="editBtn" onclick="editEntry(${i})">EDIT</button>
        <button class="actionBtn" onclick="delEntry(${i})">DELETE</button>
      </td>
    </tr>`;
  });
}
loadTable();

function delEntry(i){
  let arr = JSON.parse(localStorage.getItem("expiryAudit"));
  arr.splice(i,1);
  localStorage.setItem("expiryAudit",JSON.stringify(arr));
  loadTable();
}

function editEntry(i){
  let arr = JSON.parse(localStorage.getItem("expiryAudit"));
  let x = arr[i];

  pName.value=x.name;

  /* ðŸ”¥ ARTICLE NUMBER ADDED */
  pArtiNo.value=x.artiNo;

  pBatch.value=x.batch;
  pBarcode.value=x.barcode;
  pMfg.value=x.mfgName;
  pPrice.value=x.price;
  pQty.value=x.qty;
  pReason.value=x.reason;

  arr.splice(i,1);
  localStorage.setItem("expiryAudit",JSON.stringify(arr));
  loadTable();
}

function exportCSV(){
  let arr = JSON.parse(localStorage.getItem("expiryAudit")||"[]");
  let csv="Name,Article Number,Batch No,Barcode,Manufacturer,MFG,EXP,Audit Date,% Left,Qty,Price,Reason\n";
  arr.forEach(r=>{
    csv+=`${r.name},${r.artiNo},${r.batch},${r.barcode},${r.mfgName},${r.mfg},${r.exp},${r.audit},${r.pct},${r.qty},${r.price},${r.reason}\n`;
  });
  let blob=new Blob([csv],{type:"text/csv"});
  let a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download="Expiry_Report.csv";
  a.click();
}

function resetReport(){
  if(confirm("Delete all saved data?")){
    localStorage.removeItem("expiryAudit");
    loadTable();
  }
}

// Auto calculate
[mfgDate, expDate, currentDate].forEach(f=>{
  f.addEventListener("change", calculate);
  f.addEventListener("input", calculate);
});

currentDate.value = new Date().toISOString().split("T")[0];
</script>

<link rel="manifest" href="manifest.json">
<script>
if("serviceWorker" in navigator){
 navigator.serviceWorker.register("./service-worker.js");
}
</script>

</body>
</html>
